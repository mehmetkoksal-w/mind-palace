# Workflows

## Setup (Once)

```sh
palace init          # Create .palace/ structure
palace scan          # Build initial index
```

## Daily Loop

### Terminal

```sh
# After changes
palace scan                    # Rebuild index
palace context "your goal"     # Generate context pack

# Before agent work
palace check                   # Confirm freshness
palace query "auth logic"      # Find relevant code
```

### VS Code (Automatic)

```
Edit files → Save → Extension runs check → Auto-heal if stale
```

The Observer extension handles the loop automatically:

1. **Save file** - triggers debounced check
2. **If stale** - runs `palace scan`
3. **HUD updates** - green (fresh) or red (stale)

## Diff-Scoped Workflows

Constrain context to only changed files:

```sh
# Verify only changed files
palace check --diff HEAD~1..HEAD

# Generate context for only affected files
palace context "fix bug" --diff HEAD~1..HEAD

# CI signal for change tracking
palace ci signal --diff HEAD~1..HEAD
```

Useful for:
- CI pipelines (verify only PR changes)
- Large monorepos (avoid full scans)
- Focused agent sessions

## CI Integration

```yaml
# .github/workflows/verify.yml
- name: Verify Mind Palace
  run: |
    palace ci verify --strict --diff ${{ github.event.pull_request.base.sha }}..${{ github.sha }}
```

Exit codes:
- `0` - Fresh, proceed
- `1` - Stale, fail CI
- `2` - Config error

## Agent Sessions

### Via MCP (Recommended)

```json
{
  "mcpServers": {
    "mind-palace": {
      "command": "palace",
      "args": ["serve", "--root", "/path/to/project"]
    }
  }
}
```

Agent can then:
1. Call `search_mind_palace` to find code
2. Call `list_rooms` to understand structure
3. Call `get_context` to generate context packs
4. Call `get_graph` to explore call relationships
5. Read files via `palace://files/{path}`

### Via Context Pack

```sh
palace context "Fix the auth bug"
# Hand context-pack.json to agent
```

## Brain Workflow

Track ideas, decisions, and outcomes:

```sh
# Capture decisions as you make them
palace remember "Let's use JWT for authentication"
palace remember "What if we add caching here?"

# Record outcomes
palace outcome d_abc123 successful
palace outcome d_xyz789 failed --notes "Performance issues"

# Review old decisions
palace review --days 7

# Link related decisions
palace link d_new --supersedes d_old
```

## Session Memory Workflow

Track agent sessions and learnings:

```sh
# Start a session
palace session start --agent claude --goal "Fix auth bug"

# Capture learnings during work
palace learn "Always check for null users first"
palace learn "This file has edge cases" --scope file --path auth.go

# Get briefing before editing
palace brief src/auth.go

# End session
palace session end SESSION_ID

# Later, recall learnings
palace recall "authentication"
palace intel src/auth.go
```

---

## Command Reference

| Command | Purpose | Key Flags |
|---------|---------|-----------|
| `palace init` | Create .palace/ | `--with-outputs` |
| `palace scan` | Build/rebuild index | `--incremental` |
| `palace check` | Verify freshness | `--fast`, `--strict`, `--diff` |
| `palace query` | Search index | `--room`, `--limit` |
| `palace context` | Generate context pack | `--diff`, `--allow-stale` |
| `palace graph` | Explore call relationships | `--callers`, `--callees` |
| `palace serve` | Start MCP server | `--root` |
| `palace remember` | Store idea/decision | - |
| `palace outcome` | Record decision outcome | `--notes` |
| `palace session` | Manage sessions | `start`, `end`, `list` |
| `palace learn` | Store learning | `--scope`, `--path` |
| `palace recall` | Search learnings | `--decisions`, `--ideas` |
| `palace intel` | File intelligence | - |
| `palace brief` | Get briefing | `--verbose` |

---

## VS Code Extension

### HUD States

| State | Meaning | Action |
|-------|---------|--------|
| Green | Index is fresh | None needed |
| Red | Files changed | Auto-heal or manual scan |
| Amber | Scanning | Wait |

### Configuration

Settings in `.palace/palace.jsonc` override VS Code settings:

```jsonc
{
  "vscode": {
    "autoSync": true,
    "autoSyncDelay": 3000,
    "decorations": { "enabled": true },
    "sidebar": { "defaultView": "tree" }
  }
}
```

### Sidebar

- **Tree view** - Rooms as folders, files as entries
- **Graph view** - Cytoscape visualization of connections
- **Search** - Query Butler directly from sidebar
