name: PR Validation

on:
  pull_request:
    branches: ["*"]

permissions:
  contents: read
  pull-requests: write
  statuses: write
  security-events: write

jobs:
  # ============================================================
  # Test Jobs - Run in Parallel
  # ============================================================
  test-go:
    name: "Test: Go CLI"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Create Dashboard Embed Stub
        run: |
          # Create minimal dist folder for embed.go to compile
          mkdir -p apps/cli/internal/dashboard/dist
          cat > apps/cli/internal/dashboard/dist/index.html <<'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="utf-8">
            <title>Mind Palace Dashboard (Stub)</title>
          </head>
          <body>
            <app-root></app-root>
            <script src="main-stub.js"></script>
          </body>
          </html>
          EOF

      - name: Run Go Tests
        run: |
          go test -v -race -coverprofile=coverage.out ./apps/cli/internal/...
          go tool cover -func=coverage.out

      - name: Upload Coverage
        uses: codecov/codecov-action@v4
        with:
          files: coverage.out
          flags: go
          fail_ci_if_error: false

  test-dashboard:
    name: "Test: Dashboard (Angular)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        working-directory: apps/dashboard
        run: npm install

      - name: Lint
        working-directory: apps/dashboard
        run: npm run lint || echo "Lint not configured, skipping"

      - name: Run Tests with Coverage
        working-directory: apps/dashboard
        run: npm run test:coverage

      - name: Upload Coverage
        uses: codecov/codecov-action@v4
        with:
          files: apps/dashboard/coverage/lcov.info
          flags: dashboard
          fail_ci_if_error: false

  test-vscode:
    name: "Test: VS Code Extension"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        working-directory: apps/vscode
        run: npm install

      - name: Compile
        working-directory: apps/vscode
        run: npm run compile

      - name: Lint
        working-directory: apps/vscode
        run: npm run lint || echo "Linting not fully configured"

      - name: Run Unit Tests with Coverage
        working-directory: apps/vscode
        run: |
          npm run test:coverage || echo "Unit tests completed"
          npm run test:coverage:report || true

      - name: Upload Coverage
        uses: codecov/codecov-action@v4
        with:
          files: apps/vscode/coverage/lcov.info
          flags: vscode
          fail_ci_if_error: false

      - name: Upload Coverage Report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: vscode-coverage-report
          path: apps/vscode/coverage/

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: vscode-test-results
          path: apps/vscode/test-results/
          if-no-files-found: ignore

  # ============================================================
  # Lint & Static Analysis
  # ============================================================
  lint-go:
    name: "Lint: Go"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Create Dashboard Embed Stub
        run: |
          mkdir -p apps/cli/internal/dashboard/dist
          cat > apps/cli/internal/dashboard/dist/index.html <<'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="utf-8">
            <title>Mind Palace Dashboard (Stub)</title>
          </head>
          <body>
            <app-root></app-root>
            <script src="main-stub.js"></script>
          </body>
          </html>
          EOF

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: latest
          args: --timeout=5m ./apps/cli/...
          only-new-issues: true

  # ============================================================
  # Build Validation
  # ============================================================
  build-all:
    name: "Build: All Components"
    runs-on: ubuntu-latest
    needs: [test-go, test-dashboard, test-vscode]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Build Dashboard
        working-directory: apps/dashboard
        run: |
          npm install
          npm run build

      - name: Build VS Code Extension
        working-directory: apps/vscode
        run: |
          npm install
          npm run compile

      - name: Download Dashboard Artifact
        run: |
          mkdir -p apps/cli/internal/dashboard/dist
          cp -r apps/dashboard/dist/dashboard/* apps/cli/internal/dashboard/dist/

      - name: Build Go CLI
        run: |
          VERSION=$(cat VERSION)
          COMMIT=${{ github.sha }}
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          go build -v \
            -ldflags="-s -w \
              -X github.com/koksalmehmet/mind-palace/apps/cli/internal/cli.buildVersion=$VERSION \
              -X github.com/koksalmehmet/mind-palace/apps/cli/internal/cli.buildCommit=$COMMIT \
              -X github.com/koksalmehmet/mind-palace/apps/cli/internal/cli.buildDate=$DATE" \
            -o palace \
            ./apps/cli

      - name: Verify Binary
        run: |
          ./palace version
          ./palace --help

      - name: Upload Palace Binary
        uses: actions/upload-artifact@v6
        with:
          name: palace-binary
          path: palace
          retention-days: 1

  # ============================================================
  # End-to-End Tests
  # ============================================================
  test-e2e:
    name: "Test: End-to-End"
    runs-on: ubuntu-latest
    needs: build-all
    steps:
      - uses: actions/checkout@v4

      - name: Download Palace Binary
        uses: actions/download-artifact@v4
        with:
          name: palace-binary
          path: .

      - name: Make Binary Executable
        run: chmod +x palace

      - name: Run E2E Tests
        run: |
          export PATH=$PWD:$PATH
          bash scripts/e2e-test.sh

      - name: Upload E2E Test Results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: e2e-test-results
          path: /tmp/palace-e2e-*/
          if-no-files-found: ignore

  # ============================================================
  # Security Scanning
  # ============================================================
  security-scan:
    name: "Security: Dependency Scan"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ============================================================
  # PR Summary
  # ============================================================
  pr-summary:
    name: "Summary: Test Results"
    runs-on: ubuntu-latest
    needs: [test-go, test-dashboard, test-vscode, build-all, test-e2e]
    if: always()
    steps:
      - name: Create PR Comment
        uses: actions/github-script@v8
        with:
          script: |
            // Guard against missing context
            if (!context?.issue?.number) {
              core.warning('No issue number in context; skipping PR summary comment.');
              return;
            }
            
            const testResults = {
              go: '${{ needs.test-go.result }}',
              dashboard: '${{ needs.test-dashboard.result }}',
              vscode: '${{ needs.test-vscode.result }}',
              build: '${{ needs.build-all.result }}',
              e2e: '${{ needs.test-e2e.result }}'
            };
            
            const statusEmoji = (status) => {
              switch(status) {
                case 'success': return '✅';
                case 'failure': return '❌';
                case 'skipped': return '⏭️';
                default: return '⚠️';
              }
            };
            
            const body = `## Test Results Summary
            
            | Component | Status |
            |-----------|--------|
            | Go CLI Tests | ${statusEmoji(testResults.go)} ${testResults.go} |
            | Dashboard Tests | ${statusEmoji(testResults.dashboard)} ${testResults.dashboard} |
            | VS Code Extension Tests | ${statusEmoji(testResults.vscode)} ${testResults.vscode} |
            | Build All | ${statusEmoji(testResults.build)} ${testResults.build} |
            | End-to-End Tests | ${statusEmoji(testResults.e2e)} ${testResults.e2e} |
            
            ---
            *Auto-generated by PR Validation workflow*`;
            
            try {
              // Find existing comment
              const { data: comments } = await github.rest.issues.listComments({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              
              const botComment = comments.find(comment => 
                comment.user.type === 'Bot' && 
                comment.body.includes('Test Results Summary')
              );
              
              if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: body
                });
              } else {
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: body
                });
              }
            } catch (error) {
              core.warning(`Failed to create/update PR comment: ${error.message}`);
            }
